<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Slide Scolder</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Changa+One&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

  <div class="app-shell">

    <header class="top-nav">
      <div class="logo">
        <span class="logo-icon">üìê</span>
        <div class="title-text">
          <span>SLIDE</span>
          <span>SCOLDER</span>
        </div>
      </div>
      <div class="nav-links">
        <a href="#" class="nav-link active">JUDGE</a>
        <a href="#" class="nav-link inactive">ROASTS</a>
      </div>
    </header>

    <div class="main-layout">
      <!-- Left Panel: Hero & Inputs -->
      <section class="input-panel">
        <div class="hero-section">
          <div class="avatar-wrapper">
            <img src="{{ url_for('static', filename='teacher_avatar.png') }}" alt="Strict Teacher"
              class="teacher-avatar">
            <div class="sticker">NO EXCUSES!</div>
          </div>
          <div class="hero-text">
            <h1 class="main-title">Slide Scolder</h1>
            <p class="subtitle">"Is this a slide or a wiki dump?"</p>
          </div>
        </div>

        <form id="scold-form" action="/rate" method="post" enctype="multipart/form-data" class="compact-form">
          <input type="hidden" name="model" value="qwen-flash">
          <input type="hidden" name="base_url" value="https://dashscope-intl.aliyuncs.com/compatible-mode/v1">
          <input type="checkbox" name="stream" id="stream-checkbox" value="on" checked style="display:none;">
          <input type="checkbox" name="per_metric" value="on" checked style="display:none;">

          <div class="field-group">
            <div class="drop-zone" id="drop-zone">
              <div class="cloud-icon">‚òÅÔ∏è</div>
              <div class="drop-content">
                <p class="drop-text" id="drop-text">Drop PDF/PPTX here</p>
                <span class="drop-subtext">or click to browse</span>
              </div>
              <input type="file" name="deck" id="file-input" accept=".pdf,.pptx" required>
            </div>
          </div>

          <div class="controls-grid">
            <div class="field-group">
              <label class="label-title">üë§ PERSONALITY</label>
              <select name="mode" class="styled-select">
                <option value="student" selected>Boring (Student)</option>
                <option value="expert">Strict (Expert)</option>
              </select>
            </div>

            <div class="field-group">
              <label class="label-title">üîë API KEY</label>
              <input type="password" name="api_key" class="api-input" placeholder="Optional">
            </div>
          </div>

          <button type="submit" class="submit-btn" id="submit-btn">START SCOLDING</button>
          <div id="error-area" class="error-text"></div>
        </form>

        <div class="panel-footer">
          <a href="#">Terms</a> ‚Ä¢ <a href="#">Rights</a> ‚Ä¢ <a href="#">Report</a>
        </div>
      </section>

      <!-- Right Panel: Output Engine -->
      <section class="output-panel" id="output-panel">
        <div class="panel-header">
          <h2 class="panel-title">Scolding Engine Output</h2>
          <div class="status-indicator" id="status-indicator">STANDBY</div>
        </div>

        <div class="output-content">
          <div id="welcome-message" class="welcome-msg">
            <div class="msg-icon">üìã</div>
            <h3>Awaiting Evidence</h3>
            <p>Upload a presentation to begin the review process. No mercy will be shown.</p>
          </div>

          <div id="results-engine" style="display: none;">
            <div class="steps-container">
              <h4>PIPELINE EXECUTION</h4>
              <ul id="steps-list" class="steps-list"></ul>
            </div>

            <div id="final-verdict-container"></div>
            <div id="metrics-list" class="metrics-grid"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('scold-form');
      const fileInput = document.getElementById('file-input');
      const dropZone = document.getElementById('drop-zone');
      const dropText = document.getElementById('drop-text');
      const statusIndicator = document.getElementById('status-indicator');
      const welcomeMessage = document.getElementById('welcome-message');
      const resultsEngine = document.getElementById('results-engine');
      const stepsList = document.getElementById('steps-list');
      const metricsList = document.getElementById('metrics-list');
      const finalVerdictContainer = document.getElementById('final-verdict-container');
      const submitBtn = document.getElementById('submit-btn');
      const errorArea = document.getElementById('error-area');

      // File Input Change
      fileInput.addEventListener('change', (e) => {
        if (fileInput.files.length > 0) {
          dropText.textContent = fileInput.files[0].name;
          dropZone.classList.add('active');
        }
      });

      // Drag and Drop Visuals
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('active');
      });
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          dropText.textContent = fileInput.files[0].name;
        }
      });

      // Form Submit (Streaming Logic)
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.textContent = "SCOLDING...";

        // UI Transitions
        welcomeMessage.style.display = 'none';
        resultsEngine.style.display = 'block';
        statusIndicator.textContent = "SCOLDING...";
        statusIndicator.className = "status-indicator processing";

        stepsList.innerHTML = '';
        metricsList.innerHTML = '';
        finalVerdictContainer.innerHTML = '';
        errorArea.textContent = '';

        const stepRows = {};

        function updateStep(id, status, detail) {
          if (!stepRows[id]) {
            const li = document.createElement('li');
            li.className = 'step-item';
            li.innerHTML = `<span class="step-icon">‚óã</span> <span class="step-label">${id}</span> <span class="step-detail"></span>`;
            stepsList.appendChild(li);
            stepRows[id] = li;
          }
          const row = stepRows[id];
          const icon = row.querySelector('.step-icon');
          row.className = `step-item step-${status}`;
          if (status === 'started') icon.textContent = '‚óè';
          else if (status === 'completed') icon.textContent = '‚úì';
          else if (status === 'failed') icon.textContent = '‚úï';
        }

        try {
          const response = await fetch('/rate_stream', {
            method: 'POST',
            body: new FormData(form)
          });

          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || response.statusText);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const parts = buffer.split('\n\n');
            buffer = parts.pop() || '';

            for (const part of parts) {
              if (part.startsWith('data: ')) {
                try {
                  const data = JSON.parse(part.slice(6));
                  if (data.type === 'step') {
                    updateStep(data.step_id, data.status, data.detail);
                  } else if (data.type === 'metric') {
                    const metricDiv = document.createElement('div');
                    metricDiv.className = 'metric-card';
                    metricDiv.innerHTML = `<h3>${data.name}</h3><div class="metric-score">${data.data.score}<span>/10</span></div>`;
                    metricsList.appendChild(metricDiv);
                    metricDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
                  } else if (data.type === 'done') {
                    statusIndicator.textContent = "FINISHED";
                    statusIndicator.className = "status-indicator done";

                    finalVerdictContainer.innerHTML = `
                                            <div class="final-verdict-box">
                                                <div class="verdict-label">FINAL SCORE</div>
                                                <div class="verdict-value">${data.overall_score}</div>
                                            </div>
                                        `;
                    submitBtn.textContent = "START ANOTHER";
                    submitBtn.disabled = false;
                  } else if (data.type === 'error') {
                    errorArea.textContent = data.message;
                    statusIndicator.textContent = "ERROR";
                    statusIndicator.className = "status-indicator error";
                  }
                } catch (e) {
                  console.error("Error parsing event", e);
                }
              }
            }
          }
        } catch (err) {
          errorArea.textContent = err.message;
          submitBtn.disabled = false;
          submitBtn.textContent = "TRY AGAIN";
          statusIndicator.textContent = "FAILED";
          statusIndicator.className = "status-indicator error";
        }
      });
    });
  </script>
</body>

</html>